# Cursor Rules: Phemex Trading Bot - STRICT ENFORCEMENT

This MDC applies globally to this workspace and STRICTLY ENFORCES Phemex API usage, file structure, and trading safety.

## ğŸš¨ CRITICAL SAFETY RULES (NEVER VIOLATE)
- **LIVE_TRADE**: NEVER set to "true" without explicit user permission
- **API Keys**: NEVER log, display, or commit API keys to version control
- **Risk Limits**: NEVER exceed MAX_DAILY_LOSS_PCT or MAX_CAPITAL_FRACTION
- **Leverage**: NEVER change user-specified leverage automatically
- **Position Limits**: NEVER exceed MAX_POSITIONS limit

## ğŸ” API USAGE ENFORCEMENT
- **Exchange**: Phemex USDT-margined swaps ONLY (no spot, no coin-margined)
- **Authentication**: Always use proper HMAC-SHA256 signature with expiry
- **Rate Limiting**: Respect Phemex rate limits (100ms between requests minimum)
- **Error Handling**: Implement proper retry logic for transient errors
- **Client Cleanup**: Always close HTTP/WebSocket clients on shutdown

## ğŸ“ STRICT FILE STRUCTURE ENFORCEMENT

### Core Bot Structure (NEVER MODIFY WITHOUT PERMISSION)
```
bot/
â”œâ”€â”€ __init__.py                 # Bot package initialization
â”œâ”€â”€ config.py                   # Settings and environment loading
â”œâ”€â”€ api/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ server.py              # FastAPI webhook server
â”œâ”€â”€ engine/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ scanner.py             # Market scanner engine
â”‚   â”œâ”€â”€ discovery.py           # Symbol discovery
â”‚   â””â”€â”€ symbols.py             # Symbol management
â”œâ”€â”€ exchange/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ phemex_client.py       # Phemex API client (PRIMARY)
â”‚   â””â”€â”€ ccxt_client.py         # CCXT fallback client
â”œâ”€â”€ execution/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ brackets.py            # Bracket order management
â”‚   â””â”€â”€ execute.py             # Order execution
â”œâ”€â”€ risk/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ guards.py              # Risk management guards
â”‚   â””â”€â”€ sizing.py              # Position sizing calculations
â”œâ”€â”€ signals/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ webhook_models.py      # TradingView webhook models
â”œâ”€â”€ strategy/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ pr.py                  # Predictive ranges
â”‚   â””â”€â”€ score.py               # Signal scoring
â”œâ”€â”€ ui/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ tui_display.py         # Terminal UI
â”‚   â””â”€â”€ static/                # Web UI assets
â”œâ”€â”€ utils/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ symbol_conversion.py   # Symbol format conversion
â””â”€â”€ validation/
    â”œâ”€â”€ __init__.py
    â””â”€â”€ math_validator.py      # Mathematical validation
```

### Root Files (NEVER DELETE OR MODIFY WITHOUT PERMISSION)
- `main.py`                    # Main entry point
- `unified_trading_bot.py`     # Unified bot implementation
- `setup_live_trading.py`      # Live trading setup
- `env.template`               # Environment template
- `requirements.txt`            # Python dependencies
- `README.md`                  # Project documentation

## ğŸ¯ TRADING EXECUTION RULES

### Order Management
- **Entry Orders**: Market orders for immediate execution
- **Take Profit**: Limit orders with `reduceOnly: true`
- **Stop Loss**: Stop-Market orders with `reduceOnly: true`
- **Position Side**: Always `posSide: Merged` (one-way mode)

### Risk Management
- **Position Sizing**: Use `risk.sizing.compute_quantity()`
- **Daily Loss Limit**: Enforce `MAX_DAILY_LOSS_PCT`
- **Capital Fraction**: Never exceed `MAX_CAPITAL_FRACTION`
- **Cooldown**: Respect `ENTRY_COOLDOWN_S` between trades

### Signal Processing
- **Webhook Validation**: Verify `WEBHOOK_TOKEN` before processing
- **Signal Scoring**: Use `strategy.score.compute_total_score()`
- **Score Filter**: Only trade signals â‰¥ `SCORE_MIN`
- **Validation**: Run mathematical validation before execution

## ğŸ”§ DEVELOPMENT RULES

### Code Quality
- **Type Hints**: Use proper type annotations
- **Error Handling**: Comprehensive exception handling
- **Logging**: Structured logging with appropriate levels
- **Documentation**: Inline docstrings for all functions

### Testing
- **Dry Run**: Always test with `LIVE_TRADE=false` first
- **API Testing**: Test API connections before live trading
- **Validation**: Test all risk calculations and limits

### Environment Management
- **API Keys**: Load from environment variables only
- **Configuration**: Use `bot.config.settings` for all config
- **Secrets**: Never hardcode secrets in source code

## ğŸš« FORBIDDEN ACTIONS
- Creating new files outside the defined structure
- Modifying core bot files without explicit permission
- Adding new indicators or calculation logic
- Changing user-specified leverage or risk parameters
- Setting LIVE_TRADE=true without user approval
- Logging or displaying API keys
- Exceeding risk limits or position caps

## ğŸ“‹ REQUIRED IMPORTS AND DEPENDENCIES
```python
# Always required for bot operations
from bot.config import settings
from bot.exchange.phemex_client import get_client
from bot.risk.sizing import compute_quantity
from bot.execution.brackets import build_bracket_orders
from bot.strategy.score import compute_total_score
```

## ğŸ”„ EXECUTION FLOW (NEVER MODIFY)
1. **Startup**: Load environment variables and validate API credentials
2. **Initialization**: Initialize Phemex client and validate permissions
3. **Mode Selection**: Scanner mode or Webhook mode
4. **Signal Processing**: Validate, score, and size signals
5. **Risk Check**: Verify all risk parameters and limits
6. **Execution**: Place orders with proper risk management
7. **Monitoring**: Track positions and enforce limits
8. **Cleanup**: Close connections and log results

## âš ï¸ SAFETY CHECKLIST (ALWAYS VERIFY)
- [ ] LIVE_TRADE environment variable is set correctly
- [ ] API credentials are loaded from environment
- [ ] Risk limits are within acceptable ranges
- [ ] Position limits are not exceeded
- [ ] All orders have proper reduce-only flags
- [ ] Client connections are properly closed
- [ ] Error handling covers all failure scenarios

---
description: Strict enforcement rules for Phemex trading bot API usage and file structure
globs: ["**/*.py", "**/*.md", "**/*.json", "**/*.env*"]
alwaysApply: true
---

alwaysApply: true
---
